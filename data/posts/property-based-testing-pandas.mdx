---
title: "üêç Property Based Testing en pandas"
date: "2022-03-26"
preview: "/assets/blog/property-based-testing-pandas/testing-python-logo.png"
tags:
  - "üë®‚Äçüíª Aprendizaje"
  - "üêç Python"
---

# üêç Property Based Testing en pandas

Llevo un tiempo pensando c√≥mo poder sacarle partido a esta funcionalidad, en
pandas una librer√≠a de transformaciones de datos, gracias a Carlos Bl√© por su
consejo de intentar property based testing en las transformaciones explorando
casos l√≠mite apoyados de una librer√≠a, en este caso hypothesis.

Voy a explicar algo qu√© a lo mejor las personas qu√© no trabajan en datos no
conocen, pero la realidad es que lo ideal ser√≠a probar todos los casos l√≠mite de
los datos del d√≠a a d√≠a, esto no sucede hasta realizar la transformaci√≥n de
todos los datos, en nuestro caso un test unitario eso es inviable. Otra opci√≥n
es generar un subset de datos peque√±os a partir del grande pero lleva trabajo
realizarlo correctamente, por lo qu√© tampoco es una opci√≥n rentable porque si
ma√±ana cambian los datos no solo tendremos que rehacer ese subset sino tambi√©n
el test ya qu√© no estaba contemplando los nuevos casos de uso, eso puede generar
falsos positivos en algunos casos ya que est√° siendo probado contra datos
predefinidos y est√°ticos.

Voy a ir explicando la evoluci√≥n de menos m√°s junto con las ventajas e
inconvenientes de cada caso. En este caso imaginemos que tenemos una funci√≥n
legacy a testear:

```python
class Transformation:

    def sum_two_columns_and_generate_result(self, df: pd.DataFrame, first_column_name: str,
                                            second_column_name: str):
        df['result'] = df[first_column_name] + df[second_column_name]
        return df
```

Para realizar un test unitario primero deberemos tener en cuenta qu√© pandas
tiene su manera de interpretar los datos al leerlos al igual qu√© al
transformarlos. Por ejemplo:

```python
> np.nan + 0.0
> 0.0
```

Esto puede resultar confuso porqu√© por ejemplo si hacemos esto:

```python
> None + 0.0
> TypeError: unsupported operand type(s) for +: 'NoneType' and 'float'
```

As√≠ qu√© tanto si hacemos TDD c√≥mo si estamos testeando lo que ya est√° deberemos
tener mucho cuidado y conocimiento de la librer√≠a. La funci√≥n en este caso es
muy sencilla pero se puede complicar mucho testear transformaciones.

C√≥mo primero ejemplo podr√≠amos usar este test:

```python
def test_series_transformation_return_sum_of_columns():
    transformation = Transformation()
    val1 = 1.0
    val2 = 2.2
    df_given = pd.DataFrame(
        {
            'column_1': [val1],
            'column_2': [val2],
        }
    )
    expected_result = pd.Series([val1 + val2])

    df_calculated = transformation.sum_two_columns_and_generate_result(df_given, 'column_1', 'column_2')

    pd.testing.assert_series_equal(df_calculated.result, expected_result, check_names=False)
```

Aqu√≠ el problema de este test es qu√© los datos son est√°ticos y s√≥lo contemplan
un caso de uso por lo qu√© no es algo en lo qu√© podamos apoyarnos o confiar.

Vamos a probar pytest y pasarle algunos par√°metros m√°s:

```python
@pytest.mark.parametrize('val1, val2', [
    (0.1, 0.0),
    (1, -1),
    (0.000000001, 7.0),
    (np.nan, 0.0),
])
def test_pytest_transformation_return_sum_of_columns(val1: float, val2: float):
    transformation = Transformation()
    df_given = pd.DataFrame(
        {
            'column_1': [val1],
            'column_2': [val2],
        }
    )
    expected_result = pd.Series([val1 + val2])

    df_calculated = transformation.sum_two_columns_and_generate_result(df_given, 'column_1', 'column_2')

    pd.testing.assert_series_equal(df_calculated.result, expected_result, check_names=False)
```

Aqu√≠ tenemos un problema, lo m√°s seguro es que alg√∫n caso se nos escape, pero
nos da algo m√°s de confianza, est√° claro qu√© reflejamos todos los casos
contemplados para estos datos. Aqu√≠ yo lo veo aceptable en el caso de querer
probar unos datos espec√≠ficos. Lo ideal ser√≠a probar con esta librer√≠a:

```python
@given(val1=st.floats(),
       val2=st.floats())
def test_hypothesis_transformation_return_sum_of_columns(val1: float, val2: float):
    transformation = Transformation()
    df_given = pd.DataFrame(
        {
            'column_1': [val1],
            'column_2': [val2],
        }
    )
    expected_result = pd.Series([val1 + val2])

    df_calculated = transformation.sum_two_columns_and_generate_result(df_given, 'column_1', 'column_2')

    pd.testing.assert_series_equal(df_calculated.result, expected_result, check_names=False)
```

En el given le indicamos expl√≠citamente el tipo de propiedad a leer para poder
probar, est√° librer√≠a se encargar√° de probar los casos l√≠mite de la propiedad,
los convertir√° a datos de pandas y finalmente los probaremos con las assertions
de pandas la cu√°l comprobar√° absolutamente todo pero sin probar el nombre de la
columna, eso incluye tipos de datos lo cu√°l nos ahorra bastante trabajo por si
en medio de la transformaci√≥n se volvieron a convertir.

El problema de los casos l√≠mite estar√≠a solucionado con hypothesis pero por
ejemplo no nos dejar√≠a usar el @fixtures de pytest lo cual no me gusta, pero
bueno siempre podemos usar una o la otra dependiendo del caso.

¬øTienes curiosidad y quieres ver qu√© se ha probado en hypothesis?

Hay una forma de verlo a√±adiendo verbosity al test:

```python
@settings(verbosity=Verbosity.verbose)
@given(val1=st.floats(),
       val2=st.floats())
def test_hypothesis_transformation_return_sum_of_columns(val1: float, val2: float):
    transformation = Transformation()
    df_given = pd.DataFrame(
        {
            'column_1': [val1],
            'column_2': [val2],
        }
    )
    expected_result = pd.Series([val1 + val2])

    df_calculated = transformation.sum_two_columns_and_generate_result(df_given, 'column_1', 'column_2')

    pd.testing.assert_series_equal(df_calculated.result, expected_result, check_names=False)
```

Una vez a√±adido puede ejecutar...

```bash
 pytest [file_name].py -v -s
```

Y ver los par√°metros que ha probado en la consola:

```bash
.
.
test_transformation.py::test_hypothesis_transformation_return_sum_of_columns Trying example: test_hypothesis_transformation_return_sum_of_columns(
    val1=0.0, val2=0.0,
)
Trying example: test_hypothesis_transformation_return_sum_of_columns(
    val1=-1.2947680462195516e+16, val2=-nan,
)
Trying example: test_hypothesis_transformation_return_sum_of_columns(
    val1=-inf, val2=392874684777985.0,
)
.
.
```

¬øTienes feedback? Mi correo est√° en el footer de la p√°gina, gracias y un saludo.

[üìÅReopositorio con el ejemplo](https://github.com/Wolfremium13/property-based-testing-in-pandas)
